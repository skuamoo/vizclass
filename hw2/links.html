<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
.link {
stroke: gray;
stroke-width: .8px;
}
.node {
fill: white;
stroke: #000;
stroke-width: .9px;
}
.node:hover {
fill: black;
}
body {
 font: 8px sans-serif;
}
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>

<script>
    var margin = {top: 50, bottom: 10, left: 300, right: 40};
    var width = 1200 - margin.left - margin.right;
    var height = 900 - margin.top - margin.bottom;
    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
    //var fill = d3.scale.category10();
    var graph = {nodes: [], links: []};

    d3.json("data/countries_1995_2012.json", function(error, data){

        data = data.map(function(d) {
            var name = d.name;
            var continent = d.continent;
            var country_id = d.country_id;
            var latitude = d.latitude;
            var longitude = d.longitude;
            return d.years.map(function(e) {
                var gdp = e.gdp;
                var population = e.population;
                var year = e.year;
                var top_partners = e.top_partners;
                return {
                    "name": name,
                    "continent": continent,
                    "country_id": country_id,
                    "latitude": latitude,
                    "longitude": longitude,
                    "year": year,
                    "population": population,
                    "gdp": gdp,
                    "top_partners": top_partners
                }
            });
        });
        data = [].concat.apply([], data);
        graph.nodes = data;
        graph.links = data.map(function(d) {
            var country_id = d.country_id;
            var year = d.year;
            return d.top_partners.map(function(e) {
                var country_id2 = e.country_id;
                var total_export = e.total_export;
                return {
                    "source": country_id,
                    "target": country_id2,
                    "total_export": total_export,
                    "year": year
                }
            });

        }); 

        graph.links = [].concat.apply([], graph.links);

        graph.links = graph.links.filter(function(d) {return d.year == 2012;});
        graph.nodes = graph.nodes.filter(function(d) {return d.year == 2012;});

        graph.links.forEach(function(e) { 
                var sourceNode = graph.nodes.filter(function(n) { return n.country_id === e.source; })[0],
                targetNode = graph.nodes.filter(function(n) { return n.country_id === e.target; })[0];        
            e.source = sourceNode;
            e.target = targetNode;    
                
        });  

        var link = svg.selectAll(".link")
            .data(graph.links);
        link.enter().append("line")
            .attr("class", "link");
        var node = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("g").attr("class", "node");
        node.append("circle")
            .attr("r", 5);
        node.append("text")
            .text(function(d) { return d.name; }); 


        circular_layout();

        function circular_layout() {
            var r = Math.min(height, width)/1.2;
            var arc = d3.svg.arc()
                .outerRadius(r);
            var pie = d3.layout.pie()
                .sort(function(a, b) { return a.country_id - b.country_id;}) // Sorting by categories
                .value(function(d, i) {
                    return 1; // We want an equal pie share/slice for each point
                });
            graph.nodes = pie(graph.nodes).map(function(d, i) {
            // Needed to caclulate the centroid
                d.innerRadius = 0;
                d.outerRadius = r;
            // Building the data object we are going to return
                d.data.x = arc.centroid(d)[0]+width/2;
                d.data.y = arc.centroid(d)[1]+height/2;
                return d.data;
            })

            graph_update(500);
        }

        function graph_update(duration) {
console.log(graph.links[0].target.x);
            link.transition().duration(duration)
                .attr("x1", function(d) { return d.target.x; })
                .attr("y1", function(d) { return d.target.y; })
                .attr("x2", function(d) { return d.source.x; })
                .attr("y2", function(d) { return d.source.y; });
            node.transition().duration(duration)
            .attr("transform", function(d) {
                return "translate("+d.x+","+d.y+")";
            });
        } 


});