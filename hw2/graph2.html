<!DOCTYPE html>
<meta charset="utf-8">
<title>Homework 2 Graph</title>
<style>
  .link {
    stroke: gray;
    stroke-width: .8px;
  }

  .node {
    fill: white;
    stroke: #000;
    stroke-width: .9px;
  }
  
  .node:hover {
    fill: black;
    stroke-opacity: 1;
  }

  .linkshow {
    stroke-opacity: 1;
    stroke-width: 2px;
  }

  .linkdim {
    stroke-opacity: 0.1;
  }

  .nodedim {
    stroke-opacity: 0.1;
  }

  svg {
    font: 10px sans-serif;
  }

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <form>
  <label><input class="views" type="radio" name="views" value="rankings" checked>Rankings</label>

  &nbsp;
  Rank by:
  <select id="rankby">
  <option value="population" selected>Population</option>
  <option value="gdp">GDP</option>
  <option value="life">Life Expectancy</option> 
  </select>
  &nbsp;
  Rank Positioning:
  <label><input class="position" type="radio" name="position" value="relative" checked>Relative</label>
  <label><input class="position" type="radio" name="position" value="absolute" >Absolute</label>
  <br />
  <label><input class="views" type="radio" name="views" value="scatter">Scatter Plot</label>
  &nbsp;
  <select id="plotby">
  <option value="gdppop" selected>Population/GDP</option>
  <option value="latlon">Longitude/Latitude</option>
  </select> 
  <br />
  <label><input class="views" type="radio" name="views" value="circular">Circular Layout</label>
  &nbsp;
  Sort by:
  <select id="sortby">
  <option value="population" selected>Population</option>
  <option value="gdp">GDP</option>
  </select>
  &nbsp;
  <label><input class="cirgroup" type="checkbox" name="cirgroup">Group by Continent</label>
  <br />
  <label><input class="views" type="radio" name="views" value="force">Force Layout</label>
  &nbsp;
  <label><input class="fgroup" type="checkbox" name="fgroup">Group by Continent</label>
  &nbsp;
  Grouping Type:
  <select id="forcegroup">
  <option value="cont_xscale" selected>Continent (X Scale)</option>
  <option value="cont_circle">Continent (Circular)</option>
  </select>
  <br />
  <label><input class="views" type="radio" name="views" value="trade">Trade Partners (Circular Layout)</label>  
  </form>
<script>

    var margin = {top: 50, bottom: 10, left: 300, right: 40};
    var width = 1200 - margin.left - margin.right;
    var height = 1200 - margin.top - margin.bottom;
    var padding = 10;
    var continents = ["Americas", "Africa", "Asia", "Europe", "Oceania"]; 
    var selection = "population";
	var cirselection = "population";
    var position = "relative";
    var plot_by = "gdppop";
    var view_by = "rankings";
    var sort_by = "population";
    var group_by = "grouped";
    var fgrouped = false;
	var cgrouped = false;
    var force_group = "cont_xscale";
	var cont = [{continent: "Americas"}, {continent: "Africa"}, {continent: "Asia"}, {continent: "Europe"}, {continent: "Oceania"}];


    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);

    var fill = d3.scale.category10();

    var graph = {nodes: [], links: []};


    d3.json("data/countries_1995_2012.json", function(error, data){

        data = data.map(function(d) {
            var name = d.name;
            var continent = d.continent;
            var country_id = d.country_id;
            var latitude = d.latitude;
            var longitude = d.longitude;
            return d.years.map(function(e) {
                var gdp = e.gdp;
                var population = e.population;
                var year = e.year;
				var life_expectancy = e.life_expectancy;
                var top_partners = e.top_partners;
                return {
                    "name": name,
                    "continent": continent,
                    "country_id": country_id,
                    "latitude": latitude,
                    "longitude": longitude,
                    "year": year,
                    "population": population,
                    "gdp": gdp,
					"life_expectancy": life_expectancy,
                    "top_partners": top_partners
                }
            });
        });
        data = [].concat.apply([], data);
		var data_year = data.filter(function(d) {return d.year == 2012;});
        graph.nodes = data_year;
        graph.nodes.forEach(function(d) { 
            d.gdp = +d.gdp;
            d.life_expectancy = d3.round(d.life_expectancy, 1); 
            d.population = +d.population; 
            d.year = +d.year; 
           }); 
        graph.links = data_year.map(function(d) {
            var country_id = d.country_id;
            var year = d.year;
            return d.top_partners.map(function(e) {
                var country_id2 = e.country_id;
                var total_export = e.total_export;
                return {
                    "source": country_id,
                    "target": country_id2,
                    "total_export": total_export,
                    "year": year
                }
            });
        }); 

        graph.links = [].concat.apply([], graph.links);
        graph.links.forEach(function(e) { 
                var sourceNode = graph.nodes.filter(function(n) { return n.country_id === e.source; })[0],
                targetNode = graph.nodes.filter(function(n) { return n.country_id === e.target; })[0];
			if (!targetNode) {
			} else {
            e.source = sourceNode;
            e.target = targetNode;    }                
        });  

//        graph.links = graph.links.filter(function(d) {return d.year == 2012;});
//        graph.nodes = graph.nodes.filter(function(d) {return d.year == 2012;});	
	
        graph.nodes.sort(function(a, b) { return d3.ascending(a["name"], b["name"]);});

        var link = svg.selectAll(".link")
            .data(graph.links);
        link.enter().append("line")
            .attr("class", "link");		
		link.attr("opacity", 0);
		
        var node = svg.selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("g").attr("class", "node");
        node.append("circle")
            .attr("r", 5);
        node.append("text")
            .text(function(d) {return d.name;})
            .attr("x", function() {return 8;})
            .attr("y", function() {return 3;});
		node.on("mouseover", mouseovered)
			.on("mouseout", mouseouted);

        var force = d3.layout.force()
            .size([width, height])
            .charge(-50)
            .linkDistance(10)
            .on("tick", tick)
            .on("start", function(d) {})
            .on("end", function(d) {});

        function tick(d) {
            var width = 1400 - margin.left - margin.right;
            var xScale = d3.scale.ordinal()
                .domain(continents)
                .rangeBands([0, width]);
			var k = d.alpha * .1;
            if (fgrouped && force_group == "cont_xscale") {
                graph.nodes.forEach(function(o) {
                    o.x += (xScale(o.continent) - o.x)*k;
                });
            } else if (fgrouped && force_group == "cont_circle") {
				pieScale();
				graph.nodes.forEach(function(o) { 
					cont_pie.map(function(n) { 
						if (o.continent == n.continent) {
							o.x += (n.x - o.x)*k;
							o.y += (n.y - o.y)*k;
						}
					}); 
				}); 
            }
            graph_update(0);
        }

		rank_value();

        function rank_value() {
            force.stop();
            height = 700 - margin.top - margin.bottom;
            width = 900 - margin.left - margin.right;

            if (selection == "population") {
                graph.nodes.forEach(function(d) {                       
                    d.rank_val = d.population;
                });    
            } else if (selection == "gdp") {
                graph.nodes.forEach(function(d) {                       
                    d.rank_val = d.gdp;    
                });
            } else {
                graph.nodes.forEach(function(d) {                       
                    d.rank_val = d.life_expectancy;    
                });
            } 
            if (position == "relative") {
                graph.nodes.sort(function(a, b) { return a.rank_val - b.rank_val;});
                graph.nodes.forEach(function(d, i) {                       
                    d.rank_val = i;    
                });
            height = 1200 - margin.top - margin.bottom;
            }

            var yScale = d3.scale.linear()
                .domain([d3.min(graph.nodes, function(d) { return d.rank_val; }), d3.max(graph.nodes, function(d) { return d.rank_val; })])
                .range([height - padding, padding]);
            graph.nodes.forEach(function(d, i) {
                d.x = width/2;
                d.y = yScale(d.rank_val);
            });
            graph_update(500);    
        }

        function scatter_value() {
            force.stop();
            height = 700 - margin.top - margin.bottom;
            width = 1200 - margin.left - margin.right;
            if (plot_by == "gdppop") {
                graph.nodes.forEach(function(d) {                       
                    d.xval = d.gdp;
                    d.yval = d.population;
                });    
            } else {
                graph.nodes.forEach(function(d) {                       
                    d.xval = d.longitude;
                    d.yval = d.latitude;
                });
            }
            var yScale = d3.scale.linear()
                .domain([d3.min(graph.nodes, function(d) { return d.yval; }), d3.max(graph.nodes, function(d) { return d.yval; })])
                .range([height - padding, padding]);
            var xScale = d3.scale.linear()
                .domain([d3.min(graph.nodes, function(d) { return d.xval; }), d3.max(graph.nodes, function(d) { return d.xval; })])
                .range([padding, width - 7*padding]);

            graph.nodes.forEach(function(d, i) {
                d.x = xScale(d.xval);
                d.y = yScale(d.yval);
            });
            graph_update(500);    
        } 

        function circular_layout() {
            force.stop();
            height = 700 - margin.top - margin.bottom;
            width = 900 - margin.left - margin.right;
            var r = Math.min(height, width)/1.2;
            if (cirselection == "population") {
                graph.nodes.forEach(function(d) {                       
                    d.sort_val = d.population;
                });    
            } else {
                graph.nodes.forEach(function(d) {                       
                    d.sort_val = d.gdp;    
                });
            } 
            var arc = d3.svg.arc()
                .outerRadius(r);

            var pie = d3.layout.pie()
                .sort(function(a, b) { return a.sort_val - b.sort_val;}) 
                .value(function(d, i) { 
                    return 1;  // We want an equal pie share/slice for each point
                });
				
            graph.nodes = pie(graph.nodes).map(function(d, i) {
            // Needed to caclulate the centroid
                d.innerRadius = 0;
                d.outerRadius = r;
            // Building the data object we are going to return
                d.data.x = arc.centroid(d)[0]+ width/2;
                d.data.y = arc.centroid(d)[1]+ height/2;
                return d.data;
            })
             graph_update(500);
        }

        function force_layout() {
            force.nodes(graph.nodes)
 //               .links(graph.links)
                .start();
        }
		
		function pieScale() {
				var r = Math.min(height, width)/1.2;
 				var arc = d3.svg.arc()
					.outerRadius(r);
				var pie = d3.layout.pie()
					.value(function(d, i) { 
						return 1;  // We want an equal pie share/slice for each point
					});
				cont_pie = pie(cont).map(function(d, i) {
					d.innerRadius = 0;
					d.outerRadius = r;
					d.data.x = arc.centroid(d)[0]+width/2;
					d.data.y = arc.centroid(d)[1]+height/2;
					return d.data;
				})
		}
		
		function group_circles() {
			pieScale();
			var r = Math.min(height, width)/5;
			var arc = d3.svg.arc()
				.outerRadius(r);
			var pie = d3.layout.pie()
				.value(function(d, i) { 
					return 1;  // We want an equal pie share/slice for each point
				});
			var cgroups = [];	
			cont_pie.forEach(function(d) {
				cgroup = graph.nodes.filter(function(e) { return (e.continent == d.continent);});
				cgroup = pie(cgroup).map(function(f, i) {
					f.innerRadius = 0;
					f.outerRadius = r;
					f.data.x = arc.centroid(f)[0]+d.x;
					f.data.y = arc.centroid(f)[1]+d.y;
					cgroups.push(f.data);
				});						
			}); 
			graph.nodes = cgroups;
			graph_update(500);
		}

        function graph_update(duration) {
            node.transition().duration(duration)
                .attr("transform", function(d) { 
                    return "translate("+d.x+","+d.y+")"; 
                });

			link.transition().duration(duration)
				.attr("x1", function(d) { return d.target.x; })
				.attr("y1", function(d) { return d.target.y; })
				.attr("x2", function(d) { return d.source.x; })
				.attr("y2", function(d) { return d.source.y; });

        } 

        d3.select("#rankby")
            .on("change", function() {
                   selection = d3.select(this).property("value");
                if (view_by == "rankings") {
                    rank_value();
                }
            });

        d3.select("#sortby")
            .on("change", function() {
                cirselection = d3.select(this).property("value");

                if (view_by == "circular") {
					if (cgrouped) {
						group_circles();
					} else {
						circular_layout();
					}					
                }
            });

        d3.selectAll("input.position")
            .on("change", function() {
                   position = d3.select(this).property("value");
                if (view_by == "rankings") {
                    rank_value();    
                }
            });

        d3.selectAll("input.views")
            .on("change", function() {
                view_by = d3.select(this).property("value");
                if (view_by == "rankings") {
                    rank_value(); 
					link.attr("opacity", 0);					
                } else if (view_by == "scatter"){
                    scatter_value();
					link.attr("opacity", 0);
                } else if (view_by == "circular") {
                    circular_layout();
					link.attr("opacity", 0);
                } else if (view_by == "force") {
                    force_layout();
					link.attr("opacity", 0);
                } else if (view_by == "trade") {
					circular_layout();
					link.attr("opacity", 1);
				}
            });

        d3.select("#plotby")
            .on("change", function() {
                   plot_by = d3.select(this).property("value");
                if (view_by == "scatter") {
                    scatter_value();
                }
            });    

        d3.selectAll("input.fgroup")
            .on("change", function() {
                fgrouped = !fgrouped;
                if (view_by == "force") {
                    force_layout();
                }
            });

		d3.selectAll("input.cirgroup")
            .on("change", function() {
                cgrouped = !cgrouped;
                if (view_by == "circular") {
					if (cgrouped) {
						group_circles();
					} else {
						circular_layout();
					}					
                }
            });

        d3.select("#forcegroup")
            .on("change", function() {
                   force_group = d3.select(this).property("value");
                if (view_by == "force") {
                    force_layout();
                }
            });
			
		function mouseovered(d) {  //derived from http://bl.ocks.org/mbostock/7607999
			if (view_by == "trade") {
				node.each(function(n) { n.target = n.source = true; });
				link
					.classed("linkdim", function(k) { if (k.source != d) return true;})
					.classed("linkshow", function(l) { if (l.source === d) return l.target.target = false; });
				node.classed("nodedim", function(n) { return n.target; });
			}
		}

		function mouseouted(d) {  //derived from http://bl.ocks.org/mbostock/7607999
			if (view_by == "trade") {
				link.classed("linkdim", false);
				node.classed("nodedim", false);
			}
		}
});


</script>
</body>
</html>